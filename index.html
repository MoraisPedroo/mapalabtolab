<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DP Printer Monitor</title>
    <link rel="icon" href="logo.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        /* --- Mapa --- */
        .map-outer-container {
            height: 100vh; width: 100vw; padding: 1rem;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 0;
        }
        .map-wrapper-responsive {
            width: 100%; height: 100%; max-height: 90vh; max-width: 1200px;
            display: flex; justify-content: center; align-items: center;
            filter: drop-shadow(0 20px 13px rgb(0 0 0 / 0.03));
        }
        .state-path {
            fill: #e2e8f0; stroke: #fff; stroke-width: 1.5px; cursor: pointer; transition: all 0.3s ease;
            vector-effect: non-scaling-stroke;
        }
        .state-path:hover { fill: #cbd5e1; transform: translateY(-2px); }
        .state-path.active { fill: #4f46e5 !important; filter: drop-shadow(0 0 15px rgba(79, 70, 229, 0.4)); z-index: 10; }
        .map-wrapper-responsive.has-active .state-path:not(.active) { fill: #f1f5f9; opacity: 0.5; }

        /* --- Sidebar --- */
        #sidebar-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 50; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .lc-details { transition: max-height 0.4s ease; max-height: 0; overflow: hidden; }
        .lc-details.open { max-height: 600px; overflow-y: auto; }
        
        /* --- Busca e Dropdown --- */
        #search-container { transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1); width: 48px; }
        #search-container.expanded { width: 340px; } 
        #global-search-input { transition: opacity 0.2s ease 0.1s; opacity: 0; pointer-events: none; }
        #search-container.expanded #global-search-input { opacity: 1; pointer-events: auto; }

        /* Dropdown com Animação de Entrada/Saída */
        #search-results-dropdown {
            opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.98);
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: none;
        }
        #search-results-dropdown.visible { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }

        /* --- Botões de Controle Externos (Topo) --- */
        .control-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 99px;
            font-size: 12px; font-weight: 600;
            background: white; border: 1px solid #e2e8f0; color: #64748b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; select-none: none;
        }
        .control-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .control-btn:active { transform: translateY(0); }

        .control-btn[data-active="true"][data-type="local"] { background-color: #ecfdf5; border-color: #10b981; color: #059669; }
        .control-btn[data-active="true"][data-type="server"] { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; }
        .control-btn[data-active="false"] { opacity: 0.6; filter: grayscale(100%); background-color: #f8fafc; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #cbd5e1; transition: background-color 0.3s; }
        .control-btn[data-active="true"][data-type="local"] .status-dot { background-color: #10b981; box-shadow: 0 0 6px #10b981; }
        .control-btn[data-active="true"][data-type="server"] .status-dot { background-color: #3b82f6; box-shadow: 0 0 6px #3b82f6; }

        /* Botão Ação Nuvem (Destaque) */
        .cloud-action-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white; border-radius: 99px; font-weight: 600; font-size: 11px;
            padding: 8px 16px; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); border: none;
        }
        .cloud-action-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.3); }

        /* --- Filtros Internos (Pills) --- */
        .type-filter-btn {
            font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            padding: 5px 12px; border-radius: 6px; border: 1px solid #e2e8f0; color: #64748b; background: white;
            transition: all 0.2s;
        }
        .type-filter-btn:hover { background: #f8fafc; color: #334155; }
        .type-filter-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }

        @keyframes highlight-pulse { 0% { background-color: #fff; } 50% { background-color: #e0e7ff; } 100% { background-color: #fff; } }
        .highlight-card { animation: highlight-pulse 2s ease-in-out infinite; border-color: #6366f1; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-slate-50 text-slate-800">

    <main class="h-full w-full relative overflow-hidden group">
        <div class="absolute top-6 left-6 z-20 pointer-events-none select-none">
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Monitoramento <span class="text-indigo-600">Brasil</span></h1>
            <p class="text-xs text-slate-400 font-medium ml-0.5">Gestão Inteligente de Ativos</p>
        </div>

        <div class="absolute top-6 right-6 z-40 flex items-center gap-4">
            
            <div class="flex items-center gap-2 bg-white/60 backdrop-blur-md p-1.5 rounded-full border border-white shadow-lg shadow-slate-200/50">
                
                <button id="btn-local" class="control-btn" data-type="local" data-active="true" onclick="toggleSource('local', event)">
                    <span class="status-dot"></span>
                    <span>Locais</span>
                </button>

                <button id="btn-server" class="control-btn" data-type="server" data-active="true" onclick="toggleSource('server', event)">
                    <span class="status-dot"></span>
                    <span>Nuvem</span>
                </button>

                <div class="w-px h-6 bg-slate-300 mx-1"></div>

                <button id="btn-action-cloud" onclick="listCloudPrinters(event)" class="cloud-action-btn" title="Garante que a nuvem está ativa e abre a lista">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    <span>Listagem</span>
                </button>
            </div>

            <div class="relative flex flex-col items-end">
                <div id="search-container" class="relative flex items-center bg-white rounded-full shadow-xl shadow-slate-200/50 h-12 border border-slate-100 z-50 transition-all">
                    <button id="search-trigger" class="flex-shrink-0 w-12 h-12 flex items-center justify-center text-slate-400 hover:text-indigo-600 z-20 relative focus:outline-none transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                    <input type="text" id="global-search-input" placeholder="Pesquisar..." 
                        class="absolute left-0 top-0 w-full h-full pl-12 pr-6 border-0 rounded-full focus:ring-0 outline-none text-sm bg-transparent z-10 text-slate-700 font-medium placeholder:text-slate-400"
                        autocomplete="off">
                </div>

                <div id="search-results-dropdown" class="absolute top-14 right-0 w-[360px] bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden max-h-[80vh] flex flex-col z-40 ring-1 ring-slate-900/5 origin-top-right">
                    
                    <div class="px-4 py-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span id="list-header-label" class="text-xs font-bold text-slate-700 uppercase tracking-wider">Resultados</span>
                            <span id="results-count" class="text-[10px] font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <button onclick="closeSearch()" class="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded transition-colors" title="Fechar Lista">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>

                    <div class="px-3 py-2 bg-white border-b border-slate-100 flex items-center gap-2 overflow-x-auto custom-scroll shadow-sm z-10">
                        <button class="type-filter-btn active" onclick="setTypeFilter('all')" data-type="all">Todos</button>
                        <button class="type-filter-btn" onclick="setTypeFilter('serial')" data-type="serial">Serial</button>
                        <button class="type-filter-btn" onclick="setTypeFilter('lc')" data-type="lc">LC</button>
                        <button class="type-filter-btn" onclick="setTypeFilter('selb')" data-type="selb">SELB</button>
                    </div>

                    <div id="search-results-list" class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1 bg-white relative min-h-[100px]"></div>
                </div>
            </div>
        </div>

        <div id="global-stats" class="absolute bottom-8 left-8 z-20 flex gap-4 transition-all duration-500">
            <div class="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-lg border border-white/50 w-32 hover:scale-105 transition-transform">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Estados</p>
                <p class="text-3xl font-black text-slate-800 tracking-tight" id="total-states-count">-</p>
            </div>
            <div class="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-lg border border-white/50 w-32 hover:scale-105 transition-transform">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Ativos</p>
                <p class="text-3xl font-black text-indigo-600 tracking-tight" id="total-records-count">-</p>
            </div>
        </div>

        <div class="map-outer-container">
            <div id="map-wrapper" class="map-wrapper-responsive relative">
                <p id="loading-text" class="text-slate-400 animate-pulse font-medium">Carregando mapa...</p>
                <div id="map-tooltip" class="absolute hidden bg-slate-800 text-white text-xs font-medium py-1.5 px-3 rounded-md shadow-xl pointer-events-none transform -translate-x-1/2 -translate-y-full mt-[-8px] z-50 whitespace-nowrap"></div>
            </div>
        </div>
    </main>

    <aside id="sidebar-panel" class="fixed right-0 top-0 h-full w-full md:w-[480px] bg-white shadow-2xl transform translate-x-full flex flex-col border-l border-slate-100">
        <div class="p-6 border-b border-slate-100 bg-slate-50/50 z-10 backdrop-blur-sm">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <span id="detail-state-badge" class="px-3 py-1 bg-indigo-100 text-indigo-700 text-[10px] font-bold rounded-full uppercase tracking-wider border border-indigo-200">Estado</span>
                    <h2 id="detail-state-name" class="text-3xl font-bold text-slate-800 mt-3 leading-none tracking-tight">Selecione</h2>
                </div>
                <button id="close-sidebar" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600 focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="relative group">
                <input type="text" id="local-search" placeholder="Filtrar neste estado..." 
                    class="w-full pl-11 pr-4 py-3 rounded-xl bg-white border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm transition-all shadow-sm font-medium text-slate-600">
                <svg class="w-5 h-5 text-slate-400 absolute left-3.5 top-3.5 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 custom-scroll space-y-6 bg-white">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 border border-slate-100 p-5 rounded-2xl text-center hover:bg-slate-100 transition-colors">
                    <p class="text-3xl font-black text-indigo-600 leading-tight" id="detail-lc-count">0</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Laboratórios</p>
                </div>
                <div class="bg-slate-50 border border-slate-100 p-5 rounded-2xl text-center hover:bg-slate-100 transition-colors">
                    <p class="text-3xl font-black text-emerald-500 leading-tight" id="detail-serial-count">0</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Total Seriais</p>
                </div>
            </div>
            <div id="lc-list-container" class="space-y-4"></div>
            <div id="no-filter-results" class="hidden flex flex-col items-center justify-center py-12 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                <span class="text-sm font-medium">Nenhum resultado local.</span>
            </div>
        </div>
    </aside>

    <script src="dados_locais.js"></script>

    <script>
        // --- Setup ---
        let dbData = []; 
        let activeState = null;
        
        // ESTADOS
        let filters = { local: true, server: true };
        let filterType = 'all'; // all, serial, lc, selb
        let isListOpen = false; 

        let els = {}; 
        const stateNames = { 'AC': 'Acre', 'AL': 'Alagoas', 'AP': 'Amapá', 'AM': 'Amazonas', 'BA': 'Bahia', 'CE': 'Ceará', 'DF': 'Distrito Federal', 'ES': 'Espírito Santo', 'GO': 'Goiás', 'MA': 'Maranhão', 'MT': 'Mato Grosso', 'MS': 'Mato Grosso do Sul', 'MG': 'Minas Gerais', 'PA': 'Pará', 'PB': 'Paraíba', 'PR': 'Paraná', 'PE': 'Pernambuco', 'PI': 'Piauí', 'RJ': 'Rio de Janeiro', 'RN': 'Rio Grande do Norte', 'RS': 'Rio Grande do Sul', 'RO': 'Rondônia', 'RR': 'Roraima', 'SC': 'Santa Catarina', 'SP': 'São Paulo', 'SE': 'Sergipe', 'TO': 'Tocantins' };

        function init() {
            els = {
                sidebar: document.getElementById('sidebar-panel'),
                mapWrapper: document.getElementById('map-wrapper'),
                closeBtn: document.getElementById('close-sidebar'),
                tooltip: document.getElementById('map-tooltip'),
                
                // KPIs
                kpiStates: document.getElementById('total-states-count'),
                kpiRecords: document.getElementById('total-records-count'),
                globalStats: document.getElementById('global-stats'),
                
                // Sidebar Detalhes
                dStateName: document.getElementById('detail-state-name'),
                dStateBadge: document.getElementById('detail-state-badge'),
                dLcCount: document.getElementById('detail-lc-count'),
                dSerialCount: document.getElementById('detail-serial-count'),
                lcList: document.getElementById('lc-list-container'),
                localSearch: document.getElementById('local-search'),
                noFilterResults: document.getElementById('no-filter-results'),

                // Busca e Lista
                searchContainer: document.getElementById('search-container'),
                searchTrigger: document.getElementById('search-trigger'),
                globalInput: document.getElementById('global-search-input'),
                searchResultsDropdown: document.getElementById('search-results-dropdown'),
                searchResultsList: document.getElementById('search-results-list'),
                resultsCount: document.getElementById('results-count'),
                listHeaderLabel: document.getElementById('list-header-label'),
                
                // Botões de Controle
                btnLocal: document.getElementById('btn-local'),
                btnServer: document.getElementById('btn-server'),
                btnActionCloud: document.getElementById('btn-action-cloud')
            };

            setupEventListeners();
            fetchData();
            loadMap();
        }

        function setupEventListeners() {
            if(els.closeBtn) els.closeBtn.addEventListener('click', closeSidebar);
            
            // Trigger da Busca (Lupa)
            els.searchTrigger.addEventListener('click', (e) => { 
                e.stopPropagation();
                if(isListOpen) closeSearch(); 
                else openSearch(); 
                els.globalInput.focus(); 
            });
            
            // Input da Busca
            els.globalInput.addEventListener('input', () => {
                if(!isListOpen) openSearch();
                runSearchLogic(); 
            });
            
            // Sidebar Search
            els.localSearch.addEventListener('input', handleLocalSearch);

            // Fechar ao clicar fora (Ignorando os botões de controle para não fechar acidentalmente)
            document.addEventListener('click', (e) => {
                if (isListOpen && 
                    !els.searchContainer.contains(e.target) && 
                    !els.searchResultsDropdown.contains(e.target) &&
                    !els.btnActionCloud.contains(e.target) &&
                    !els.btnLocal.contains(e.target) &&
                    !els.btnServer.contains(e.target)
                    ) { 
                    closeSearch();
                }
            });
        }

        // --- LÓGICA DE CONTROLE (BOTÕES DE TOPO) ---
        window.toggleSource = function(type, e) {
            e.stopPropagation(); // Impede que o clique feche o dropdown
            
            // 1. Alterna estado
            filters[type] = !filters[type];

            // 2. Atualiza Visual do Botão
            const btn = (type === 'local') ? els.btnLocal : els.btnServer;
            btn.dataset.active = filters[type];

            // 3. Atualiza KPIs e Mapa
            updateGlobalKPIs();

            // 4. Se a lista estiver aberta, atualiza ela também imediatamente
            if (isListOpen) {
                runSearchLogic(true); 
            }
        };

        // --- AÇÃO: LISTAGEM (BOTÃO LATERAL) ---
        window.listCloudPrinters = function(e) {
            e.stopPropagation(); // Impede fechamento
            
            // Garante que a Nuvem esteja ativa para ver os resultados
            if(!filters.server) {
                filters.server = true;
                els.btnServer.dataset.active = "true";
            }
            // NOTA: Não mexemos no estado do Local (se estava on, continua on = lista tudo)

            // Atualiza KPIs
            updateGlobalKPIs();

            // Limpa o input (opcional, se quiser ver tudo)
            els.globalInput.value = '';
            
            // Abre o dropdown
            openSearch();
            
            // Força a renderização da lista
            runSearchLogic(true); 
        }

        // --- FILTROS INTERNOS (Serial, LC, etc) ---
        window.setTypeFilter = function(type) {
            filterType = type;
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                if(btn.dataset.type === type) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            // Re-renderiza a lista se estiver aberta
            if(isListOpen) runSearchLogic(true);
        };

        // --- FUNÇÕES DE BUSCA ---
        function openSearch() {
            isListOpen = true;
            els.searchContainer.classList.add('expanded');
            els.searchResultsDropdown.classList.add('visible');
        }

        window.closeSearch = function() { // Função Global
            isListOpen = false;
            els.searchContainer.classList.remove('expanded');
            els.searchResultsDropdown.classList.remove('visible');
            els.globalInput.blur();
        }

        function runSearchLogic(forceRender = false) {
            const query = els.globalInput.value.trim().toUpperCase();
            
            // Pega dados baseados nos filtros ativos (Local/Server)
            const activeData = getActiveData();

            // Filtra por texto E tipo
            const matches = activeData.filter(d => {
                // Filtro de Texto
                const q = query;
                const matchSerial = d.serial.toUpperCase().includes(q);
                const matchLC = d.lc.toUpperCase().includes(q);
                const matchSELB = d.selb && d.selb.toUpperCase().includes(q);

                // Filtro de Tipo
                let typeMatch = false;
                if (filterType === 'all') typeMatch = (matchSerial || matchLC || matchSELB);
                else if (filterType === 'serial') typeMatch = matchSerial;
                else if (filterType === 'lc') typeMatch = matchLC;
                else if (filterType === 'selb') typeMatch = matchSELB;

                // Se não tem texto digitado, e forçou renderização (ex: clicou botão), mostra tudo
                if (forceRender && query.length === 0) return true;
                
                // Se não tem texto e não foi forçado, retorna falso (esconde, a menos que listOpen esteja true por outro motivo)
                if (!forceRender && query.length === 0) return true; // Mudança: se input vazio, mostra lista completa se estiver aberta

                return typeMatch;
            }).slice(0, 100); 

            // Atualiza Label do Header
            if (query.length === 0) els.listHeaderLabel.textContent = "Listagem Completa (Ativos)";
            else els.listHeaderLabel.textContent = "Resultados da Busca";

            renderSearchResults(matches, query, activeData.length);
        }

        function renderSearchResults(matches, query, totalActive) {
            els.searchResultsList.innerHTML = '';
            els.resultsCount.textContent = matches.length;

            if (matches.length === 0) {
                els.searchResultsList.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs">Nenhum registro encontrado nos filtros ativos.</div>`;
            } else {
                matches.forEach(match => {
                    const el = document.createElement('div');
                    el.className = 'p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0 transition-all rounded-lg group flex justify-between items-center';
                    
                    const highlight = (text) => (query && text) ? text.replace(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), m => `<span class="text-indigo-600 font-black bg-indigo-50 px-0.5 rounded">${m}</span>`) : (text || '');

                    const sourceBadge = match.source === 'local' 
                        ? `<span class="text-[9px] font-bold text-slate-500 bg-slate-100 px-1 rounded border border-slate-200" title="Local">L</span>`
                        : `<span class="text-[9px] font-bold text-sky-600 bg-sky-50 px-1 rounded border border-sky-100" title="Nuvem">N</span>`;

                    const selbBadge = match.selb ? `<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded ml-1 border border-slate-200">SELB: ${highlight(match.selb)}</span>` : '';

                    el.innerHTML = `
                        <div class="flex-1 min-w-0 pr-3">
                            <div class="flex items-center gap-2 mb-1">
                                ${sourceBadge}
                                <span class="font-mono font-bold text-slate-700 text-sm truncate">${highlight(match.serial)}</span>
                                ${selbBadge}
                            </div>
                            <div class="flex items-center gap-2 text-xs text-slate-500">
                                <span class="bg-indigo-50 text-indigo-700 px-1.5 rounded font-bold">LC ${highlight(match.lc)}</span>
                                <span class="truncate max-w-[150px]">${match.cidade || match.estado}</span>
                            </div>
                        </div>
                        <div class="text-right flex-shrink-0 flex flex-col items-end">
                            <span class="text-[9px] font-bold text-slate-300 group-hover:text-indigo-500 transition-colors mt-0.5">ABRIR &rarr;</span>
                        </div>
                    `;
                    el.addEventListener('click', () => {
                        selectState(match.estado, match.lc);
                        closeSearch(); 
                    });
                    els.searchResultsList.appendChild(el);
                });
            }
        }

        // --- FETCH DADOS ---
        async function fetchData() {
            const localRaw = (typeof BANCO_INTERNO !== 'undefined') ? BANCO_INTERNO : [];
            const normalizedInternal = localRaw.map(item => ({
                lc: String(item.lc), serial: String(item.numero_serie), selb: item.selb || '',
                estado: item.uf ? item.uf.toUpperCase() : 'XX', cidade: item.cidade,
                data_registro: null, source: 'local'
            }));

            let processedFirebase = [];
            const url = 'https://dpprinter-logs-ff3a7-default-rtdb.firebaseio.com/inventario.json';
            try {
                const response = await fetch(url);
                const rawData = await response.json();
                if (rawData) {
                    for (const lcCode in rawData) {
                        for (const serialKey in rawData[lcCode]) {
                            const item = rawData[lcCode][serialKey];
                            let dateObj = null;
                            if (item.data_registro) dateObj = new Date(item.data_registro.replace(' ', 'T'));
                            processedFirebase.push({
                                lc: String(item.lc || lcCode), serial: String(item.serial), selb: item.selb || '',
                                estado: item.estado ? item.estado.toUpperCase() : 'XX', cidade: item.cidade,
                                data_registro: dateObj, source: 'server'
                            });
                        }
                    }
                }
            } catch (error) { console.error("Erro Server", error); }

            dbData = [...normalizedInternal, ...processedFirebase];
            updateGlobalKPIs();
        }

        function getActiveData() {
            return dbData.filter(d => {
                if (d.source === 'local' && !filters.local) return false;
                if (d.source === 'server' && !filters.server) return false;
                return true;
            });
        }

        function updateGlobalKPIs() {
            const activeData = getActiveData();
            if(els.kpiStates) els.kpiStates.textContent = [...new Set(activeData.filter(d => d.estado !== 'XX').map(d => d.estado))].length;
            if(els.kpiRecords) els.kpiRecords.textContent = activeData.length.toLocaleString('pt-BR');
        }

        // --- MAPA E SIDEBAR ---
        function loadMap() {
            const mapUrl = 'https://raw.githubusercontent.com/giuliano-macedo/brazil-states-geojson/master/brazil_states.svg';
            fetch('assets/map.svg').then(r => r.ok ? r.text() : fetch(mapUrl).then(r=>r.text())).then(svgData => {
                if(els.mapWrapper) {
                    els.mapWrapper.innerHTML = svgData;
                    const svg = els.mapWrapper.querySelector('svg');
                    if(svg) {
                        svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
                        svg.querySelectorAll('path').forEach(p => {
                            const id = p.id || p.getAttribute('name');
                            if(id && id.includes('-')) p.id = id.split('-')[1];
                        });
                        els.mapWrapper.appendChild(els.tooltip); 
                        setupMapInteractions(svg);
                    }
                }
            });
        }

        function setupMapInteractions(svg) {
            svg.querySelectorAll('path').forEach(p => {
                p.classList.add('state-path');
                if(p.id) {
                    p.addEventListener('click', (e) => selectState(e.currentTarget.id.toUpperCase()));
                    p.addEventListener('mouseenter', (e) => {
                        const id = e.currentTarget.id.toUpperCase();
                        const activeData = getActiveData();
                        const count = activeData.filter(d => d.estado === id).length;
                        showTooltip(e, `${stateNames[id] || id} • ${count}`);
                    });
                    p.addEventListener('mousemove', moveTooltip);
                    p.addEventListener('mouseleave', hideTooltip);
                }
            });
        }

        function selectState(uf, targetLc = null) {
            if(!uf || uf === 'XX') return;
            activeState = uf;
            document.querySelectorAll('.state-path').forEach(p => p.classList.remove('active'));
            const el = document.getElementById(uf) || document.getElementById(uf.toLowerCase());
            if(el) el.classList.add('active');
            
            if(els.mapWrapper) els.mapWrapper.classList.add('has-active');
            if(els.sidebar) els.sidebar.classList.remove('translate-x-full');
            if(els.globalStats) els.globalStats.classList.add('translate-y-20', 'opacity-0');
            els.localSearch.value = ''; 
            populateSidebar(uf, targetLc);
        }

        function closeSidebar() {
            activeState = null;
            document.querySelectorAll('.state-path').forEach(p => p.classList.remove('active'));
            if(els.mapWrapper) els.mapWrapper.classList.remove('has-active');
            if(els.sidebar) els.sidebar.classList.add('translate-x-full');
            if(els.globalStats) els.globalStats.classList.remove('translate-y-20', 'opacity-0');
        }

        function populateSidebar(uf, targetLc = null) {
            const activeData = getActiveData();
            const stateData = activeData.filter(d => d.estado === uf);
            const lcs = [...new Set(stateData.map(d => d.lc))].sort();

            els.dStateName.textContent = stateNames[uf] || uf;
            els.dStateBadge.textContent = uf;
            els.dLcCount.textContent = lcs.length;
            els.dSerialCount.textContent = stateData.length;
            els.lcList.innerHTML = '';
            els.noFilterResults.classList.add('hidden');

            if (lcs.length === 0) {
                els.lcList.innerHTML = `<p class="text-sm text-slate-400 italic text-center py-10">Nenhum dado ativo.</p>`;
                return;
            }

            lcs.forEach(lc => {
                const lcRecords = stateData.filter(d => d.lc === lc);
                lcRecords.sort((a,b) => {
                    if (a.source === 'local') return 1; 
                    if (b.source === 'local') return -1;
                    return b.data_registro - a.data_registro;
                });

                const city = lcRecords[0].cidade || 'Local Desconhecido';
                const isTarget = (targetLc && String(lc) === String(targetLc));
                
                const card = document.createElement('div');
                card.className = `lc-card bg-white border border-slate-200 rounded-xl overflow-hidden mb-3 transition-all hover:shadow-md ${isTarget ? 'ring-2 ring-indigo-500 shadow-lg highlight-card' : ''}`;
                
                const header = document.createElement('div');
                header.className = 'p-4 flex justify-between items-center cursor-pointer bg-white hover:bg-slate-50 transition-colors select-none';
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center text-xs font-bold text-white shadow-indigo-200 shadow-lg">LC</div>
                        <div>
                            <span class="font-bold text-slate-700 text-lg block leading-none">LC ${lc}</span>
                            <span class="text-[10px] text-slate-400 font-medium uppercase tracking-wide mt-1 block">${city}</span>
                        </div>
                    </div>
                    <span class="text-xs font-bold bg-slate-100 border border-slate-200 px-3 py-1 rounded-full text-slate-600">${lcRecords.length}</span>
                `;

                const details = document.createElement('div');
                details.className = `lc-details bg-slate-50 border-t border-slate-100 ${isTarget ? 'open' : ''}`;
                
                let serialsHtml = '<ul class="divide-y divide-slate-100">';
                lcRecords.forEach(record => {
                    const dateStr = record.data_registro ? record.data_registro.toLocaleDateString('pt-BR') : 'Local';
                    const icon = record.source === 'local'
                        ? `<svg class="w-4 h-4 text-slate-400" title="Local" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>`
                        : `<svg class="w-4 h-4 text-sky-500" title="Cloud" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>`;

                    serialsHtml += `
                        <li class="px-5 py-3 hover:bg-white transition-colors flex justify-between items-center text-sm group/item">
                            <div class="flex items-center gap-3">
                                ${icon}
                                <span class="font-semibold text-slate-700 font-mono tracking-tight">${record.serial}</span>
                            </div>
                            <span class="text-[10px] font-medium text-slate-400">${dateStr}</span>
                        </li>
                    `;
                });
                serialsHtml += '</ul>';
                details.innerHTML = serialsHtml;

                header.addEventListener('click', () => {
                    if(details.classList.contains('open')) details.classList.remove('open'); 
                    else details.classList.add('open');
                });

                card.appendChild(header);
                card.appendChild(details);
                els.lcList.appendChild(card);
                if(isTarget) setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            });
        }

        function handleLocalSearch() {
            const query = els.localSearch.value.toUpperCase();
            document.querySelectorAll('.lc-card').forEach(card => {
                if (card.innerText.toUpperCase().includes(query)) {
                    card.style.display = 'block';
                    if(query.length > 0) card.querySelector('.lc-details').classList.add('open');
                    else card.querySelector('.lc-details').classList.remove('open');
                } else card.style.display = 'none';
            });
        }

        function showTooltip(e, text) { if(els.tooltip) { els.tooltip.textContent = text; els.tooltip.classList.remove('hidden'); moveTooltip(e); }}
        function moveTooltip(e) { if(els.tooltip) { els.tooltip.style.left = `${e.pageX}px`; els.tooltip.style.top = `${e.pageY + (window.innerWidth<768?-40:0)}px`; }}
        function hideTooltip() { if(els.tooltip) els.tooltip.classList.add('hidden'); }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>