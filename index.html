<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DP Printer Monitor</title>
    <link rel="icon" href="logo.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; overflow: hidden; }
        
        /* --- Mapa --- */
        .map-outer-container {
            height: 100vh; width: 100vw; padding: 1rem;
            display: flex; align-items: center; justify-content: center;
            position: relative; z-index: 0;
        }
        .map-wrapper-responsive {
            width: 100%; height: 100%; max-height: 90vh; max-width: 1200px;
            display: flex; justify-content: center; align-items: center;
            filter: drop-shadow(0 20px 13px rgb(0 0 0 / 0.03));
        }
        .state-path {
            fill: #e2e8f0; stroke: #fff; stroke-width: 1.5px; cursor: pointer; transition: all 0.3s ease;
            vector-effect: non-scaling-stroke;
        }
        .state-path:hover { fill: #cbd5e1; transform: translateY(-2px); }
        .state-path.active { fill: #4f46e5 !important; filter: drop-shadow(0 0 15px rgba(79, 70, 229, 0.4)); z-index: 10; }
        .map-wrapper-responsive.has-active .state-path:not(.active) { fill: #f1f5f9; opacity: 0.5; }

        /* --- Sidebar --- */
        #sidebar-panel { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); z-index: 50; }
        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        .lc-details { transition: max-height 0.4s ease; max-height: 0; overflow: hidden; }
        .lc-details.open { max-height: 600px; overflow-y: auto; }
        
        /* --- Busca e Dropdown --- */
        #search-container { transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1); width: 48px; }
        #search-container.expanded { width: 340px; } 
        #global-search-input { transition: opacity 0.2s ease 0.1s; opacity: 0; pointer-events: none; }
        #search-container.expanded #global-search-input { opacity: 1; pointer-events: auto; }

        #search-results-dropdown {
            opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.98);
            transition: all 0.25s cubic-bezier(0.16, 1, 0.3, 1); pointer-events: none;
        }
        #search-results-dropdown.visible { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }

        /* --- Botões de Controle --- */
        .control-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 16px; border-radius: 99px;
            font-size: 12px; font-weight: 600;
            background: white; border: 1px solid #e2e8f0; color: #64748b;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; select-none: none;
        }
        .control-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .control-btn:active { transform: translateY(0); }

        .control-btn[data-active="true"][data-type="local"] { background-color: #ecfdf5; border-color: #10b981; color: #059669; }
        .control-btn[data-active="true"][data-type="server"] { background-color: #eff6ff; border-color: #3b82f6; color: #2563eb; }
        .control-btn[data-active="false"] { opacity: 0.6; filter: grayscale(100%); background-color: #f8fafc; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background-color: #cbd5e1; transition: background-color 0.3s; }
        .control-btn[data-active="true"][data-type="local"] .status-dot { background-color: #10b981; box-shadow: 0 0 6px #10b981; }
        .control-btn[data-active="true"][data-type="server"] .status-dot { background-color: #3b82f6; box-shadow: 0 0 6px #3b82f6; }

        /* Botão Ação Listagem */
        .list-action-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #6366f1 100%);
            color: white; border-radius: 99px; font-weight: 600; font-size: 11px;
            padding: 8px 16px; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2); border: none;
        }
        .list-action-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.3); }

        /* Botão Excel */
        .excel-btn {
            background-color: #107c41; color: white;
            border-radius: 99px; font-weight: 600; font-size: 11px;
            padding: 8px 16px; display: flex; align-items: center; justify-content: center; gap: 6px;
            transition: all 0.2s; border: none;
            box-shadow: 0 4px 6px -1px rgba(16, 124, 65, 0.2);
        }
        .excel-btn:hover { background-color: #0c5e31; transform: translateY(-1px); }

        /* Filtros Internos */
        .type-filter-btn {
            font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
            padding: 5px 12px; border-radius: 6px; border: 1px solid #e2e8f0; color: #64748b; background: white;
            transition: all 0.2s;
        }
        .type-filter-btn:hover { background: #f8fafc; color: #334155; }
        .type-filter-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; }

        /* --- MODAL DE EXPORTAÇÃO --- */
        #export-modal { opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
        #export-modal.open { opacity: 1; pointer-events: auto; }
        .preview-table th { background-color: #f8fafc; position: sticky; top: 0; z-index: 10; border-bottom: 2px solid #e2e8f0; }
        .preview-table tr:nth-child(even) { background-color: #fcfcfc; }
        .preview-table tr:hover { background-color: #f1f5f9; }
        
        /* Coluna Oculta */
        .col-hidden { display: none !important; }

        /* Chips de Coluna */
        .col-toggle {
            font-size: 11px; padding: 4px 10px; border-radius: 6px; cursor: pointer; user-select: none;
            border: 1px solid #e2e8f0; transition: all 0.2s; background: white; color: #64748b;
        }
        .col-toggle:hover { background: #f1f5f9; }
        .col-toggle.active { background: #4f46e5; color: white; border-color: #4f46e5; font-weight: 600; }

        /* Inputs do Modal */
        .modal-input {
            background: #f8fafc; border: 1px solid #e2e8f0; padding: 6px 12px;
            border-radius: 8px; font-size: 12px; color: #334155; outline: none;
            transition: all 0.2s;
        }
        .modal-input:focus { border-color: #6366f1; background: white; box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); }
        
        .exact-btn {
            border: 1px solid #e2e8f0; background: #f8fafc; color: #94a3b8;
            border-radius: 8px; padding: 0 10px; transition: all 0.2s;
        }
        .exact-btn:hover { background: #e2e8f0; color: #64748b; }
        .exact-btn.active { background: #4f46e5; color: white; border-color: #4f46e5; box-shadow: 0 2px 4px rgba(79, 70, 229, 0.3); }

        @keyframes highlight-pulse { 0% { background-color: #fff; } 50% { background-color: #e0e7ff; } 100% { background-color: #fff; } }
        .highlight-card { animation: highlight-pulse 2s ease-in-out infinite; border-color: #6366f1; }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden bg-slate-50 text-slate-800">

    <main class="h-full w-full relative overflow-hidden group">
        <div class="absolute top-6 left-6 z-20 pointer-events-none select-none">
            <h1 class="text-2xl font-bold text-slate-800 tracking-tight">Monitoramento <span class="text-indigo-600">Brasil</span></h1>
            <p class="text-xs text-slate-400 font-medium ml-0.5">Gestão Inteligente de Ativos</p>
        </div>

        <div class="absolute top-6 right-6 z-40 flex items-center gap-3">
            
            <div class="flex items-center gap-2 bg-white/60 backdrop-blur-md p-1.5 rounded-full border border-white shadow-lg shadow-slate-200/50">
                
                <button id="btn-local" class="control-btn" data-type="local" data-active="true" onclick="toggleSource('local', event)" title="Ativar/Desativar Banco Local">
                    <span class="status-dot"></span>
                    <span>Locais</span>
                </button>

                <button id="btn-server" class="control-btn" data-type="server" data-active="true" onclick="toggleSource('server', event)" title="Ativar/Desativar Nuvem">
                    <span class="status-dot"></span>
                    <span>Nuvem</span>
                </button>

                <div class="w-px h-6 bg-slate-300 mx-1"></div>

                <button onclick="openExportModal(event)" class="excel-btn" title="Exportar Dados">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                    <span>Excel</span>
                </button>

                <button id="btn-action-list" onclick="viewList(event)" class="list-action-btn" title="Ver lista com os filtros atuais">
                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
                    <span>Listagem</span>
                </button>
            </div>

            <div class="relative flex flex-col items-end">
                <div id="search-container" class="relative flex items-center bg-white rounded-full shadow-xl shadow-slate-200/50 h-12 border border-slate-100 z-50 transition-all">
                    <button id="search-trigger" class="flex-shrink-0 w-12 h-12 flex items-center justify-center text-slate-400 hover:text-indigo-600 z-20 relative focus:outline-none transition-colors">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                    </button>
                    <input type="text" id="global-search-input" placeholder="Pesquisar..." 
                        class="absolute left-0 top-0 w-full h-full pl-12 pr-6 border-0 rounded-full focus:ring-0 outline-none text-sm bg-transparent z-10 text-slate-700 font-medium placeholder:text-slate-400"
                        autocomplete="off">
                </div>

                <div id="search-results-dropdown" class="absolute top-14 right-0 w-[360px] bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden max-h-[80vh] flex flex-col z-40 ring-1 ring-slate-900/5 origin-top-right">
                    <div class="px-4 py-3 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span id="list-header-label" class="text-xs font-bold text-slate-700 uppercase tracking-wider">Resultados</span>
                            <span id="results-count" class="text-[10px] font-bold text-white bg-indigo-500 px-2 py-0.5 rounded-full">0</span>
                        </div>
                        <button onclick="closeSearch()" class="p-1 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded transition-colors" title="Fechar Lista">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                    </div>
                    <div class="px-3 py-2 bg-white border-b border-slate-100 flex items-center gap-2 overflow-x-auto custom-scroll shadow-sm z-10">
                        <button class="type-filter-btn active" onclick="setTypeFilter('all')" data-type="all">Todos</button>
                        <button class="type-filter-btn" onclick="setTypeFilter('serial')" data-type="serial">Serial</button>
                        <button class="type-filter-btn" onclick="setTypeFilter('lc')" data-type="lc">LC</button>
                        <button class="type-filter-btn" onclick="setTypeFilter('selb')" data-type="selb">SELB</button>
                    </div>
                    <div id="search-results-list" class="flex-1 overflow-y-auto custom-scroll p-2 space-y-1 bg-white relative min-h-[100px]"></div>
                </div>
            </div>
        </div>

        <div id="export-modal" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/40 backdrop-blur-sm">
            <div class="bg-white w-[95%] max-w-6xl h-[90vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden border border-slate-200">
                <div class="px-6 py-4 border-b border-slate-100 bg-slate-50 space-y-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Exportar Dados</h2>
                            <p class="text-xs text-slate-500">Selecione as colunas desejadas e filtre os dados antes de copiar.</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="copyToClipboard()" id="btn-copy-clipboard" class="flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold transition-all shadow-lg shadow-emerald-200/50">
                                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                                <span>Copiar Seleção</span>
                            </button>
                            <button onclick="closeExportModal()" class="p-2 text-slate-400 hover:text-slate-600 hover:bg-slate-200 rounded-lg">
                                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="flex items-center gap-2 py-1 flex-wrap">
                        <span class="text-[10px] font-bold text-slate-400 uppercase mr-2">Colunas:</span>
                        <button class="col-toggle active" onclick="toggleColumn('lc')" data-col="lc">LC</button>
                        <button class="col-toggle active" onclick="toggleColumn('serial')" data-col="serial">Serial</button>
                        <button class="col-toggle active" onclick="toggleColumn('selb')" data-col="selb">SELB</button>
                        <button class="col-toggle active" onclick="toggleColumn('estado')" data-col="estado">Estado</button>
                        <button class="col-toggle active" onclick="toggleColumn('cidade')" data-col="cidade">Cidade</button>
                        <button class="col-toggle active" onclick="toggleColumn('data')" data-col="data">Data</button>
                        <button class="col-toggle active" onclick="toggleColumn('origem')" data-col="origem">Origem</button>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-4 lg:grid-cols-5 gap-3 items-end bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Origem</label>
                            <select id="modal-filter-source" class="modal-input h-9 w-full" onchange="updateExportView()">
                                <option value="all">Todas</option>
                                <option value="local">Apenas Local</option>
                                <option value="server">Apenas Nuvem</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Estado</label>
                            <select id="modal-filter-state" class="modal-input h-9 w-full" onchange="updateExportView()">
                                <option value="">Todos</option>
                            </select>
                        </div>
                        <div class="flex flex-col gap-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">Cidade</label>
                            <input type="text" id="modal-filter-city" class="modal-input h-9 w-full" placeholder="Buscar..." oninput="updateExportView()">
                        </div>
                        <div class="flex flex-col gap-1 flex-1 min-w-[150px]">
                            <label class="text-[10px] font-bold text-slate-400 uppercase">LC</label>
                            <div class="flex gap-2">
                                <input type="text" id="modal-filter-lc" class="modal-input h-9 w-full" placeholder="Ex: 1234" oninput="updateExportView()">
                                <button id="btn-exact-match" onclick="toggleExactMatch()" class="exact-btn h-9 flex items-center justify-center" title="Busca Exata">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex items-center pb-2 justify-end">
                            <span class="text-xs font-bold text-indigo-600 bg-indigo-50 px-3 py-1 rounded-full border border-indigo-100 whitespace-nowrap" id="modal-count-display">0 registros</span>
                        </div>
                    </div>
                </div>

                <div class="flex-1 overflow-auto custom-scroll p-0 bg-white relative" id="export-preview-container">
                    </div>
            </div>
        </div>

        <div id="global-stats" class="absolute bottom-8 left-8 z-20 flex gap-4 transition-all duration-500">
            <div class="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-lg border border-white/50 w-32 hover:scale-105 transition-transform">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Estados</p>
                <p class="text-3xl font-black text-slate-800 tracking-tight" id="total-states-count">-</p>
            </div>
            <div class="bg-white/80 backdrop-blur-md p-4 rounded-2xl shadow-lg border border-white/50 w-32 hover:scale-105 transition-transform">
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Ativos</p>
                <p class="text-3xl font-black text-indigo-600 tracking-tight" id="total-records-count">-</p>
            </div>
        </div>

        <div class="map-outer-container">
            <div id="map-wrapper" class="map-wrapper-responsive relative">
                <p id="loading-text" class="text-slate-400 animate-pulse font-medium">Carregando mapa...</p>
                <div id="map-tooltip" class="absolute hidden bg-slate-800 text-white text-xs font-medium py-1.5 px-3 rounded-md shadow-xl pointer-events-none transform -translate-x-1/2 -translate-y-full mt-[-8px] z-50 whitespace-nowrap"></div>
            </div>
        </div>
    </main>

    <aside id="sidebar-panel" class="fixed right-0 top-0 h-full w-full md:w-[480px] bg-white shadow-2xl transform translate-x-full flex flex-col border-l border-slate-100">
        <div class="p-6 border-b border-slate-100 bg-slate-50/50 z-10 backdrop-blur-sm">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <span id="detail-state-badge" class="px-3 py-1 bg-indigo-100 text-indigo-700 text-[10px] font-bold rounded-full uppercase tracking-wider border border-indigo-200">Estado</span>
                    <h2 id="detail-state-name" class="text-3xl font-bold text-slate-800 mt-3 leading-none tracking-tight">Selecione</h2>
                </div>
                <button id="close-sidebar" class="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-slate-600 focus:outline-none">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="relative group">
                <input type="text" id="local-search" placeholder="Filtrar neste estado..." 
                    class="w-full pl-11 pr-4 py-3 rounded-xl bg-white border border-slate-200 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none text-sm transition-all shadow-sm font-medium text-slate-600">
                <svg class="w-5 h-5 text-slate-400 absolute left-3.5 top-3.5 group-focus-within:text-indigo-500 transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 custom-scroll space-y-6 bg-white">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 border border-slate-100 p-5 rounded-2xl text-center hover:bg-slate-100 transition-colors">
                    <p class="text-3xl font-black text-indigo-600 leading-tight" id="detail-lc-count">0</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Laboratórios</p>
                </div>
                <div class="bg-slate-50 border border-slate-100 p-5 rounded-2xl text-center hover:bg-slate-100 transition-colors">
                    <p class="text-3xl font-black text-emerald-500 leading-tight" id="detail-serial-count">0</p>
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mt-1">Total Seriais</p>
                </div>
            </div>
            <div id="lc-list-container" class="space-y-4"></div>
            <div id="no-filter-results" class="hidden flex flex-col items-center justify-center py-12 text-slate-400 bg-slate-50 rounded-2xl border border-dashed border-slate-200">
                <span class="text-sm font-medium">Nenhum resultado local.</span>
            </div>
        </div>
    </aside>

    <script src="dados_locais.js"></script>

    <script>
        // --- Setup ---
        let dbData = []; 
        let activeState = null;
        let filters = { local: true, server: true };
        let filterType = 'all'; 
        let isListOpen = false; 
        
        // Modal States
        let exportRawData = [];
        let isExactMatch = false;
        let visibleCols = { lc: true, serial: true, selb: true, estado: true, cidade: true, data: true, origem: true };

        let els = {}; 
        const stateNames = { 'AC': 'Acre', 'AL': 'Alagoas', 'AP': 'Amapá', 'AM': 'Amazonas', 'BA': 'Bahia', 'CE': 'Ceará', 'DF': 'Distrito Federal', 'ES': 'Espírito Santo', 'GO': 'Goiás', 'MA': 'Maranhão', 'MT': 'Mato Grosso', 'MS': 'Mato Grosso do Sul', 'MG': 'Minas Gerais', 'PA': 'Pará', 'PB': 'Paraíba', 'PR': 'Paraná', 'PE': 'Pernambuco', 'PI': 'Piauí', 'RJ': 'Rio de Janeiro', 'RN': 'Rio Grande do Norte', 'RS': 'Rio Grande do Sul', 'RO': 'Rondônia', 'RR': 'Roraima', 'SC': 'Santa Catarina', 'SP': 'São Paulo', 'SE': 'Sergipe', 'TO': 'Tocantins' };

        function init() {
            els = {
                sidebar: document.getElementById('sidebar-panel'),
                mapWrapper: document.getElementById('map-wrapper'),
                closeBtn: document.getElementById('close-sidebar'),
                tooltip: document.getElementById('map-tooltip'),
                kpiStates: document.getElementById('total-states-count'),
                kpiRecords: document.getElementById('total-records-count'),
                globalStats: document.getElementById('global-stats'),
                dStateName: document.getElementById('detail-state-name'),
                dStateBadge: document.getElementById('detail-state-badge'),
                dLcCount: document.getElementById('detail-lc-count'),
                dSerialCount: document.getElementById('detail-serial-count'),
                lcList: document.getElementById('lc-list-container'),
                localSearch: document.getElementById('local-search'),
                noFilterResults: document.getElementById('no-filter-results'),
                searchContainer: document.getElementById('search-container'),
                searchTrigger: document.getElementById('search-trigger'),
                globalInput: document.getElementById('global-search-input'),
                searchResultsDropdown: document.getElementById('search-results-dropdown'),
                searchResultsList: document.getElementById('search-results-list'),
                resultsCount: document.getElementById('results-count'),
                listHeaderLabel: document.getElementById('list-header-label'),
                btnLocal: document.getElementById('btn-local'),
                btnServer: document.getElementById('btn-server'),
                btnActionList: document.getElementById('btn-action-list'),
                
                // Modal
                exportModal: document.getElementById('export-modal'),
                exportPreviewContainer: document.getElementById('export-preview-container'),
                modalFilterSource: document.getElementById('modal-filter-source'),
                modalFilterState: document.getElementById('modal-filter-state'),
                modalFilterCity: document.getElementById('modal-filter-city'),
                modalFilterLc: document.getElementById('modal-filter-lc'),
                btnExactMatch: document.getElementById('btn-exact-match'),
                modalCountDisplay: document.getElementById('modal-count-display')
            };

            setupEventListeners();
            fetchData();
            loadMap();
        }

        function setupEventListeners() {
            if(els.closeBtn) els.closeBtn.addEventListener('click', closeSidebar);
            
            els.searchTrigger.addEventListener('click', (e) => { 
                e.stopPropagation();
                if(isListOpen) closeSearch(); 
                else openSearch(); 
                els.globalInput.focus(); 
            });
            
            els.globalInput.addEventListener('input', () => {
                if(!isListOpen) openSearch();
                runSearchLogic(); 
            });
            
            els.localSearch.addEventListener('input', handleLocalSearch);

            document.addEventListener('click', (e) => {
                if (isListOpen && 
                    !els.searchContainer.contains(e.target) && 
                    !els.searchResultsDropdown.contains(e.target) &&
                    !els.btnActionList.contains(e.target) &&
                    !els.btnLocal.contains(e.target) &&
                    !els.btnServer.contains(e.target)
                    ) { 
                    closeSearch();
                }
            });
        }

        // --- CONTROLES DE TOPO ---
        window.toggleSource = function(type, e) {
            e.stopPropagation();
            filters[type] = !filters[type];
            const btn = (type === 'local') ? els.btnLocal : els.btnServer;
            btn.dataset.active = filters[type];
            updateGlobalKPIs();
            if (isListOpen) runSearchLogic(true); 
        };

        window.viewList = function(e) {
            e.stopPropagation();
            // Apenas abre a lista respeitando o estado atual dos botões
            updateGlobalKPIs();
            els.globalInput.value = '';
            openSearch();
            runSearchLogic(true); 
        }

        window.setTypeFilter = function(type) {
            filterType = type;
            document.querySelectorAll('.type-filter-btn').forEach(btn => {
                if(btn.dataset.type === type) btn.classList.add('active');
                else btn.classList.remove('active');
            });
            if(isListOpen) runSearchLogic(true);
        };

        // --- MODAL DE EXPORTAÇÃO ---
        window.openExportModal = function(e) {
            e.stopPropagation();
            exportRawData = dbData; 
            if (exportRawData.length === 0) { alert("Nenhum dado disponível."); return; }

            populateStateFilter();
            
            // Filtros iniciais
            els.modalFilterSource.value = 'all'; 
            if(filters.local && !filters.server) els.modalFilterSource.value = 'local';
            if(!filters.local && filters.server) els.modalFilterSource.value = 'server';
            
            els.modalFilterState.value = '';
            els.modalFilterCity.value = '';
            els.modalFilterLc.value = '';
            isExactMatch = false;
            updateExactMatchBtn();

            // Colunas (Resetar se quiser)
            // visibleCols = { lc: true, serial: true, selb: true, estado: true, cidade: true, data: true, origem: true };
            
            updateExportView();
            els.exportModal.classList.add('open');
        }

        function populateStateFilter() {
            const uniqueStates = [...new Set(exportRawData.map(d => d.estado).filter(e => e !== 'XX'))].sort();
            let html = '<option value="">Todos</option>';
            uniqueStates.forEach(uf => { html += `<option value="${uf}">${stateNames[uf] || uf} (${uf})</option>`; });
            els.modalFilterState.innerHTML = html;
        }

        window.toggleExactMatch = function() {
            isExactMatch = !isExactMatch;
            updateExactMatchBtn();
            updateExportView();
        }

        function updateExactMatchBtn() {
            if(isExactMatch) els.btnExactMatch.classList.add('active');
            else els.btnExactMatch.classList.remove('active');
        }

        // Toggles de Coluna
        window.toggleColumn = function(colName) {
            visibleCols[colName] = !visibleCols[colName];
            
            // Atualiza botões visuais
            document.querySelectorAll(`.col-toggle[data-col="${colName}"]`).forEach(btn => {
                if(visibleCols[colName]) btn.classList.add('active');
                else btn.classList.remove('active');
            });

            // Atualiza Tabela
            updateExportView();
        }

        window.updateExportView = function() {
            const sourceVal = els.modalFilterSource.value;
            const stateVal = els.modalFilterState.value; 
            const cityVal = els.modalFilterCity.value.toUpperCase();
            const lcVal = els.modalFilterLc.value.toUpperCase();

            const filteredData = exportRawData.filter(item => {
                if (sourceVal === 'local' && item.source !== 'local') return false;
                if (sourceVal === 'server' && item.source !== 'server') return false;
                if (stateVal && item.estado !== stateVal) return false;
                if (cityVal && (!item.cidade || !item.cidade.toUpperCase().includes(cityVal))) return false;
                if (lcVal) {
                    if (isExactMatch) { if (item.lc !== lcVal) return false; } 
                    else { if (!item.lc.toUpperCase().includes(lcVal)) return false; }
                }
                return true;
            });

            els.modalCountDisplay.textContent = `${filteredData.length} registros`;
            renderExportTable(filteredData);
        }

        function renderExportTable(data) {
            // Helpers de visibilidade
            const show = (col) => visibleCols[col] ? '' : 'col-hidden';

            let tableHTML = `
                <table id="export-table" class="w-full text-sm text-left text-slate-600 preview-table border-collapse">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-50 border-b border-slate-200">
                        <tr>
                            <th class="px-4 py-3 font-bold ${show('lc')}">LC</th>
                            <th class="px-4 py-3 font-bold ${show('serial')}">Serial</th>
                            <th class="px-4 py-3 font-bold ${show('selb')}">SELB</th>
                            <th class="px-4 py-3 font-bold ${show('estado')}">Estado</th>
                            <th class="px-4 py-3 font-bold ${show('cidade')}">Cidade</th>
                            <th class="px-4 py-3 font-bold ${show('data')}">Data</th>
                            <th class="px-4 py-3 font-bold ${show('origem')}">Origem</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-100">
            `;

            if(data.length === 0) {
                tableHTML += `<tr><td colspan="7" class="px-4 py-8 text-center text-slate-400">Nenhum dado encontrado.</td></tr>`;
            } else {
                data.forEach(item => {
                    const dateStr = item.data_registro ? item.data_registro.toLocaleString('pt-BR') : '-';
                    const sourceStr = item.source === 'local' ? 'BANCO LOCAL' : 'NUVEM';
                    const rowClass = item.source === 'local' ? '' : 'bg-indigo-50/30';
                    
                    tableHTML += `
                        <tr class="${rowClass}">
                            <td class="px-4 py-2 font-medium ${show('lc')}">${item.lc}</td>
                            <td class="px-4 py-2 font-mono text-slate-900 ${show('serial')}">${item.serial}</td>
                            <td class="px-4 py-2 ${show('selb')}">${item.selb}</td>
                            <td class="px-4 py-2 ${show('estado')}">${item.estado}</td>
                            <td class="px-4 py-2 ${show('cidade')}">${item.cidade || ''}</td>
                            <td class="px-4 py-2 ${show('data')}">${dateStr}</td>
                            <td class="px-4 py-2 text-xs font-bold text-slate-500 ${show('origem')}">${sourceStr}</td>
                        </tr>
                    `;
                });
            }
            tableHTML += `</tbody></table>`;
            els.exportPreviewContainer.innerHTML = tableHTML;
        }

        window.closeExportModal = function() {
            els.exportModal.classList.remove('open');
            const btn = document.getElementById('btn-copy-clipboard');
            btn.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg><span>Copiar Seleção</span>`;
            btn.className = "flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-bold transition-all shadow-lg shadow-emerald-200/50";
        }

        window.copyToClipboard = function() {
            const table = document.getElementById('export-table');
            const range = document.createRange();
            range.selectNode(table);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            
            try {
                document.execCommand('copy');
                window.getSelection().removeAllRanges();
                const btn = document.getElementById('btn-copy-clipboard');
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg><span>Copiado!</span>`;
                btn.className = "flex items-center gap-2 px-4 py-2 bg-slate-800 text-white rounded-lg text-sm font-bold transition-all";
                setTimeout(() => { closeExportModal(); }, 1500);
            } catch (err) { alert('Erro ao copiar'); }
        }

        // --- BUSCA GERAL ---
        function openSearch() {
            isListOpen = true;
            els.searchContainer.classList.add('expanded');
            els.searchResultsDropdown.classList.add('visible');
        }

        window.closeSearch = function() {
            isListOpen = false;
            els.searchContainer.classList.remove('expanded');
            els.searchResultsDropdown.classList.remove('visible');
            els.globalInput.blur();
        }

        function runSearchLogic(forceRender = false) {
            const query = els.globalInput.value.trim().toUpperCase();
            
            if (!forceRender && query.length === 0) {
                els.searchResultsDropdown.classList.remove('visible');
                return;
            }

            els.searchResultsDropdown.classList.add('visible');
            const activeData = getActiveData();

            const matches = activeData.filter(d => {
                const q = query;
                const matchSerial = d.serial.toUpperCase().includes(q);
                const matchLC = d.lc.toUpperCase().includes(q);
                const matchSELB = d.selb && d.selb.toUpperCase().includes(q);

                let typeMatch = false;
                if (filterType === 'all') typeMatch = (matchSerial || matchLC || matchSELB);
                else if (filterType === 'serial') typeMatch = matchSerial;
                else if (filterType === 'lc') typeMatch = matchLC;
                else if (filterType === 'selb') typeMatch = matchSELB;

                if (query.length === 0) return true;
                return typeMatch;
            }).slice(0, 100); 

            if (query.length === 0) els.listHeaderLabel.textContent = "Listagem Completa (Ativos)";
            else els.listHeaderLabel.textContent = "Resultados da Busca";

            renderSearchResults(matches, query, activeData.length);
        }

        function renderSearchResults(matches, query, totalActive) {
            els.searchResultsList.innerHTML = '';
            els.resultsCount.textContent = matches.length;

            if (matches.length === 0) {
                els.searchResultsList.innerHTML = `<div class="p-8 text-center text-slate-400 text-xs">Nenhum registro encontrado.</div>`;
            } else {
                matches.forEach(match => {
                    const el = document.createElement('div');
                    el.className = 'p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-50 last:border-0 transition-all rounded-lg group flex justify-between items-center';
                    const highlight = (text) => (query && text) ? text.replace(new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'), m => `<span class="text-indigo-600 font-black bg-indigo-50 px-0.5 rounded">${m}</span>`) : (text || '');
                    const sourceBadge = match.source === 'local' ? `<span class="text-[9px] font-bold text-slate-500 bg-slate-100 px-1 rounded border border-slate-200">LOCAL</span>` : `<span class="text-[9px] font-bold text-sky-600 bg-sky-50 px-1 rounded border border-sky-100">NUVEM</span>`;
                    const selbBadge = match.selb ? `<span class="text-[9px] bg-slate-100 text-slate-500 px-1 rounded ml-1 border border-slate-200">SELB: ${highlight(match.selb)}</span>` : '';

                    el.innerHTML = `
                        <div class="flex-1 min-w-0 pr-3">
                            <div class="flex items-center gap-2 mb-1">${sourceBadge}<span class="font-mono font-bold text-slate-700 text-sm truncate">${highlight(match.serial)}</span>${selbBadge}</div>
                            <div class="flex items-center gap-2 text-xs text-slate-500"><span class="bg-indigo-50 text-indigo-700 px-1.5 rounded font-bold">LC ${highlight(match.lc)}</span><span class="truncate max-w-[150px]">${match.cidade || match.estado}</span></div>
                        </div>
                        <div class="text-right flex-shrink-0 flex flex-col items-end"><span class="text-[9px] font-bold text-slate-300 group-hover:text-indigo-500 transition-colors mt-0.5">ABRIR &rarr;</span></div>
                    `;
                    el.addEventListener('click', () => { selectState(match.estado, match.lc); closeSearch(); });
                    els.searchResultsList.appendChild(el);
                });
            }
        }

        // --- FETCH & MAPA (O mesmo do anterior, sem mudanças lógicas) ---
        async function fetchData() {
            const localRaw = (typeof BANCO_INTERNO !== 'undefined') ? BANCO_INTERNO : [];
            const normalizedInternal = localRaw.map(item => ({ lc: String(item.lc), serial: String(item.numero_serie), selb: item.selb || '', estado: item.uf ? item.uf.toUpperCase() : 'XX', cidade: item.cidade, data_registro: null, source: 'local' }));
            let processedFirebase = [];
            try {
                const response = await fetch('https://dpprinter-logs-ff3a7-default-rtdb.firebaseio.com/inventario.json');
                const rawData = await response.json();
                if (rawData) {
                    for (const lcCode in rawData) {
                        for (const serialKey in rawData[lcCode]) {
                            const item = rawData[lcCode][serialKey];
                            let dateObj = null;
                            if (item.data_registro) dateObj = new Date(item.data_registro.replace(' ', 'T'));
                            processedFirebase.push({ lc: String(item.lc || lcCode), serial: String(item.serial), selb: item.selb || '', estado: item.estado ? item.estado.toUpperCase() : 'XX', cidade: item.cidade, data_registro: dateObj, source: 'server' });
                        }
                    }
                }
            } catch (error) { console.error("Erro Server", error); }
            dbData = [...normalizedInternal, ...processedFirebase];
            updateGlobalKPIs();
        }

        function getActiveData() {
            return dbData.filter(d => {
                if (d.source === 'local' && !filters.local) return false;
                if (d.source === 'server' && !filters.server) return false;
                return true;
            });
        }

        function updateGlobalKPIs() {
            const activeData = getActiveData();
            if(els.kpiStates) els.kpiStates.textContent = [...new Set(activeData.filter(d => d.estado !== 'XX').map(d => d.estado))].length;
            if(els.kpiRecords) els.kpiRecords.textContent = activeData.length.toLocaleString('pt-BR');
        }

        function loadMap() {
            fetch('assets/map.svg').then(r => r.ok ? r.text() : fetch('https://raw.githubusercontent.com/giuliano-macedo/brazil-states-geojson/master/brazil_states.svg').then(r=>r.text())).then(svgData => {
                if(els.mapWrapper) {
                    els.mapWrapper.innerHTML = svgData;
                    const svg = els.mapWrapper.querySelector('svg');
                    if(svg) {
                        svg.setAttribute('width', '100%'); svg.setAttribute('height', '100%');
                        svg.querySelectorAll('path').forEach(p => { const id = p.id || p.getAttribute('name'); if(id && id.includes('-')) p.id = id.split('-')[1]; });
                        els.mapWrapper.appendChild(els.tooltip); setupMapInteractions(svg);
                    }
                }
            });
        }

        function setupMapInteractions(svg) {
            svg.querySelectorAll('path').forEach(p => {
                p.classList.add('state-path');
                if(p.id) {
                    p.addEventListener('click', (e) => selectState(e.currentTarget.id.toUpperCase()));
                    p.addEventListener('mouseenter', (e) => {
                        const id = e.currentTarget.id.toUpperCase();
                        const count = getActiveData().filter(d => d.estado === id).length;
                        showTooltip(e, `${stateNames[id] || id} • ${count}`);
                    });
                    p.addEventListener('mousemove', moveTooltip);
                    p.addEventListener('mouseleave', hideTooltip);
                }
            });
        }

        function selectState(uf, targetLc = null) {
            if(!uf || uf === 'XX') return;
            activeState = uf;
            document.querySelectorAll('.state-path').forEach(p => p.classList.remove('active'));
            const el = document.getElementById(uf) || document.getElementById(uf.toLowerCase());
            if(el) el.classList.add('active');
            if(els.mapWrapper) els.mapWrapper.classList.add('has-active');
            if(els.sidebar) els.sidebar.classList.remove('translate-x-full');
            if(els.globalStats) els.globalStats.classList.add('translate-y-20', 'opacity-0');
            els.localSearch.value = ''; 
            populateSidebar(uf, targetLc);
        }

        function closeSidebar() {
            activeState = null;
            document.querySelectorAll('.state-path').forEach(p => p.classList.remove('active'));
            if(els.mapWrapper) els.mapWrapper.classList.remove('has-active');
            if(els.sidebar) els.sidebar.classList.add('translate-x-full');
            if(els.globalStats) els.globalStats.classList.remove('translate-y-20', 'opacity-0');
        }

        function populateSidebar(uf, targetLc = null) {
            const activeData = getActiveData();
            const stateData = activeData.filter(d => d.estado === uf);
            const lcs = [...new Set(stateData.map(d => d.lc))].sort();
            els.dStateName.textContent = stateNames[uf] || uf;
            els.dStateBadge.textContent = uf;
            els.dLcCount.textContent = lcs.length;
            els.dSerialCount.textContent = stateData.length;
            els.lcList.innerHTML = '';
            els.noFilterResults.classList.add('hidden');
            if (lcs.length === 0) { els.lcList.innerHTML = `<p class="text-sm text-slate-400 italic text-center py-10">Nenhum dado ativo.</p>`; return; }
            lcs.forEach(lc => {
                const lcRecords = stateData.filter(d => d.lc === lc);
                lcRecords.sort((a,b) => { if (a.source === 'local') return 1; if (b.source === 'local') return -1; return b.data_registro - a.data_registro; });
                const city = lcRecords[0].cidade || 'Local Desconhecido';
                const isTarget = (targetLc && String(lc) === String(targetLc));
                const card = document.createElement('div');
                card.className = `lc-card bg-white border border-slate-200 rounded-xl overflow-hidden mb-3 transition-all hover:shadow-md ${isTarget ? 'ring-2 ring-indigo-500 shadow-lg highlight-card' : ''}`;
                const header = document.createElement('div');
                header.className = 'p-4 flex justify-between items-center cursor-pointer bg-white hover:bg-slate-50 transition-colors select-none';
                header.innerHTML = `<div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-indigo-600 flex items-center justify-center text-xs font-bold text-white shadow-indigo-200 shadow-lg">LC</div><div><span class="font-bold text-slate-700 text-lg block leading-none">LC ${lc}</span><span class="text-[10px] text-slate-400 font-medium uppercase tracking-wide mt-1 block">${city}</span></div></div><span class="text-xs font-bold bg-slate-100 border border-slate-200 px-3 py-1 rounded-full text-slate-600">${lcRecords.length}</span>`;
                const details = document.createElement('div');
                details.className = `lc-details bg-slate-50 border-t border-slate-100 ${isTarget ? 'open' : ''}`;
                let serialsHtml = '<ul class="divide-y divide-slate-100">';
                lcRecords.forEach(record => {
                    const dateStr = record.data_registro ? record.data_registro.toLocaleDateString('pt-BR') : 'Local';
                    const icon = record.source === 'local' ? `<svg class="w-4 h-4 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" /></svg>` : `<svg class="w-4 h-4 text-sky-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" /></svg>`;
                    serialsHtml += `<li class="px-5 py-3 hover:bg-white transition-colors flex justify-between items-center text-sm group/item"><div class="flex items-center gap-3">${icon}<span class="font-semibold text-slate-700 font-mono tracking-tight">${record.serial}</span></div><span class="text-[10px] font-medium text-slate-400">${dateStr}</span></li>`;
                });
                serialsHtml += '</ul>'; details.innerHTML = serialsHtml;
                header.addEventListener('click', () => { if(details.classList.contains('open')) details.classList.remove('open'); else details.classList.add('open'); });
                card.appendChild(header); card.appendChild(details); els.lcList.appendChild(card);
                if(isTarget) setTimeout(() => card.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300);
            });
        }

        function handleLocalSearch() {
            const query = els.localSearch.value.toUpperCase();
            document.querySelectorAll('.lc-card').forEach(card => {
                if (card.innerText.toUpperCase().includes(query)) {
                    card.style.display = 'block';
                    if(query.length > 0) card.querySelector('.lc-details').classList.add('open'); else card.querySelector('.lc-details').classList.remove('open');
                } else card.style.display = 'none';
            });
        }

        function showTooltip(e, text) { if(els.tooltip) { els.tooltip.textContent = text; els.tooltip.classList.remove('hidden'); moveTooltip(e); }}
        function moveTooltip(e) { if(els.tooltip) { els.tooltip.style.left = `${e.pageX}px`; els.tooltip.style.top = `${e.pageY + (window.innerWidth<768?-40:0)}px`; }}
        function hideTooltip() { if(els.tooltip) els.tooltip.classList.add('hidden'); }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>